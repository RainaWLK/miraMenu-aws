AWSTemplateFormatVersion: '2010-09-09'
Description: Mira Menu B2B portal service
Resources:
  S3Bucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: portal.mira.menu-bak
      AccessControl: PublicRead
      VersioningConfiguration: 
        Status: Enabled
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
    DeletionPolicy: Delete

  WebsiteCDN:
    Type: 'AWS::CloudFront::Distribution'
    Properties:
      DistributionConfig: 
        Aliases:
        - portal.mira.menu-bak
        Comment: orz
        DefaultRootObject: index.html
        Enabled: true
        IPV6Enabled: true
        PriceClass: PriceClass_100
        DefaultCacheBehavior:
          TargetOriginId: !Join
            - ''
            - - 'S3-'
              - !GetAtt
                - S3Bucket
                - DomainName
          ViewerProtocolPolicy: redirect-to-https
          MinTTL: 0
          AllowedMethods:
          - HEAD
          - GET
          CachedMethods:
          - HEAD
          - GET
          ForwardedValues:
            QueryString: true
            Cookies:
              Forward: none
          Compress: true
        Origins:
        - DomainName: !GetAtt 
          - S3Bucket
          - DomainName
          Id: !Join
            - ''
            - - 'S3-'
              - !GetAtt
                - S3Bucket
                - DomainName
          S3OriginConfig: {}
#        - DomainName: aoboid0wkl.execute-api.us-east-1.amazonaws.com
#          Id: API-aoboid0wkl.execute-api.us-east-1.amazonaws.com/auth
#          OriginPath: "/auth"
#          S3OriginConfig:
#            HTTPPort: '80'
#            HTTPSPort: '443'
#            OriginProtocolPolicy: https-only
        Restrictions:
          GeoRestriction:
            RestrictionType: none
            Locations: []
        ViewerCertificate:
          AcmCertificateArn: arn:aws:acm:us-east-1:552950262288:certificate/a301990c-6368-4b13-bb8a-dcbdb2bf0973
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.1_2016

  
#        CacheBehaviors:
#        - TargetOriginId: API-aoboid0wkl.execute-api.us-east-1.amazonaws.com/auth
#          PathPattern: "/v1/*"
#          ViewerProtocolPolicy: https-only
#          MinTTL: 0
#          AllowedMethods:
#          - HEAD
#          - DELETE
#          - POST
#          - GET
#          - OPTIONS
#          - PUT
#          - PATCH
#          CachedMethods:
#          - HEAD
#          - GET
#          - OPTIONS
#          ForwardedValues:
#            QueryString: true
#            Headers:
#            - Accept
#            - Authorization
#            - Content-Type
#            - Date
#            - Referer
#            Cookies:
#              Forward: none


Outputs:
  WebsiteURL:
    Value: !GetAtt 
      - S3Bucket
      - WebsiteURL
    Description: URL for website hosted on S3
  S3BucketSecureURL:
    Value: !Join 
      - ''
      - - 'https://'
        - !GetAtt 
          - S3Bucket
          - DomainName
    Description: Name of S3 bucket to hold website content